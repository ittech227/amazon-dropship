# Задача по переносу заказов из Amazon в Megaplan

## Подключение к проекту

Для использования расширения как самостоятельного приложения, разверните его из git'а:
```
https://github.com/rollun-com/amazon-dropship
```

Для подключения расширения в другой проект добавьте в composer.json:
```
"repositories": [
    {
      "type": "vcs",
      "url": "https://github.com/rollun-com/amazon-dropship"
    },
},
"require": {
    // ...
    "rollun-com/amazon-dropship": "dev-master"
}
```

После обновления из composer'а запустите установку.


## Установка

Для установки используется команда ```composer lib install```. В списке инсталляторов выберите **AmazonOrderInstaller**.

Все параметры этой библиотеки разделены на две группы:
* так называемые константные параметры, т.е. те, которые формально можно переопределить, но лучше этого не делать;
они находятся в ConfigProvider'е;
* параметры, которые выносятся в локальную настройку; те, которые можно и нужно заменить в зависимости от серверного
окружения.

Инсталлятор будет задавать вопросы по второй группе параметров:

1. **mode**; так называемый режим выборки; по сути означает по какому полю будет производиться выборка. Есть два варианта:
- Created; будет выбирать только те заказы, которые были созданы в указанный временной интервал.
- Modified; будет выбирать те заказы, которые (внимание!) **были созданы и/или изменены** в указанный временной интервал.
По умолчанию устанавливается режим "Modified".

2. **since_datetime**; начало временного периода для выборки. Можно указать любой формат для даты/времени, который понимает
интерпретатор PHP. Например: "-1 Hours", "2017-10-01 00:00:00". По умолчанию выборка производится за последний час ("-1 Hours").
Можно указать значение null. Но в этом случае клиент Амазона сам построит временную метку. А по умолчанию он производит
выборку за последние 2 минуты.

3. **till_datetime**; конец периода выборки. Для него действуют те же правила, что и для начала периода выборки.
По умолчанию выборка будет производиться до текущего момента.

4. Далее инсталлер попросит установить расписание для запуска. Расписание имеет синтаксис, похожий на синтаксис
для Cron'а, но гораздо более упрощенный. Можно указать только часы и минуты в массиве через запятую или символ "*",
если Вы хотите запусткать задачу каждый час/минуту.
```
// Примеры расписания:

// Каждую минуту
'hours' => ['*'],
'minutes' => ['*']

// Каждый час в начале часа
'hours' => ['*'],
'minutes' => [0]

// Каждые полчаса  в начале и в середине часа:
'hours' => ['*'],
'minutes' => [0,30]

// Два раза в сутки: в полночь и в полдень в начале часа:
'hours' => [0,12],
'minutes' => [0]
```

5. Последним вопросом будет указать путь к конфигу подключения к Амазону и название секции в этом конфиге.
Описание настройки подключения к Амазону выходит за рамки этого руководства.

После этого инсталлер создаст файл локальной конфигурации **rollun.amazonDropship.Amazon.AmazonOrder.dist.local.php**,
где будут размещены все эти параметры и введенные Вами значения.
На этом установка данного расширения завершена. Как обычно, если Вы не указали какие-то параметры во время установки,
Вы можете поменять их значения в указанном файле конфигурации.

> Сторонняя библиотека для работы с Amazon API будет логировать все свои действия. Она попытается создать файл лога
в папке /data/logs. Обязательно убедитесь, что у этой папки есть права на запись.


## Остальная конфигурация

Кроме устанавливаемых настроек есть также так называемые константные настройки, т.е. те, которые формально можно
переопределить в локальном конфиге, но лучше этого не делать. Прописаны они в классе **\rollun\amazonDropship\ConfigProvider**.

В этом файле описаны фабрики, псевдонимы для них и настройка Cron'а. Из интересного здесь - задача, которая запускается
при каждом запуске крона (обычно он запускается каждую минуту).

## AmazonOrerTaskCallback
В данном случае Cron запускает каждую минуту специальный callback, который инкапсулирует задачу. Данный callback проверяет
расписание запуска. И если расписание соответствует текущему времени, то основная задача запускается. В качестве
значений в задачу передаются параметры, описанные в разделе "Установка".


## Как это работает?

### Собственно, перенос сделок из Амазона в Мегаплан
Cron запускается (обычно) каждую минуту. В числе прочих задач (если они есть) запускается также AmazonOrderTaskCallback.
Этот callback проверяет собственное расписание запуска, к. указано в настройках.

Когда пришло время запустить задачу, она обращается к Амазону и в соответствующем режиме (mode) получает список заказов.
Далее из каждого заказа извлекаются следующие данные:
- amazonOrderId; есть всегда. Это уникальный идентификатор заказа во всем Амазоне.
- paymentDate; есть всегда. Дата заказа.
- SellerOrderId; может отсутствовать (быть равным null). Означает, что поставщик еще не принял/не обработал заказ или
заказ, например, не был оплачен. Вобщем, по какому-то ряду причин заказ пока еще существует только на Амазоне.
- Status; статус отправки. Может принимать несколько значений. Нас интересует только статус "Shipped". Он означает, что
заказ отправлен. В этом случае в специально указанный DataStore отправляется запрос на получение tracking_number для
этого заказа (его там, правда, может еще не быть).

И отправляются в Мегаплан. В зависимости от состава данных, сделка Мегаплана будет переведена в соответствующий статус.
Если сделка уже существует, то она будет обновлена переданными данными.

Бывают ситуации, когда в Мегаплан уходят одни и те же (возможно, даже неполные) данные. Это не проблема. Сделка
в Мегаплане примет тот статус, к. соответствует переданному набору данных.

### Поиск tracking-номеров для сделок, которые находятся в статусе "Ожидает отправки"
Это вторая часть запускаемой по расписанию задачи.

В Мегаплан отправляется запрос на выборку сделок, которые находятся в указанном статусе. Сам по себе этот статус
подразумевает, что в сделке не проставлен tracking number. Запрашиваем его в специальном DataStore.
Если номер для заказа найден, обновленные данные отправляются
назад в Мегаплан, и сделка автоматически переводится в следующий статус.
