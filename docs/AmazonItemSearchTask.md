# Задача по поиску товаров в Amazon

## Подключение к проекту

Для использования расширения как самостоятельного приложения, разверните его из git'а:
```
https://github.com/rollun-com/amazon-dropship
```

Для подключения расширения в другой проект добавьте в composer.json:
```
"repositories": [
    {
      "type": "vcs",
      "url": "https://github.com/rollun-com/amazon-dropship"
    },
},
"require": {
    // ...
    "rollun-com/amazon-dropship": "dev-master"
}
```

После обновления из composer'а запустите установку.


## Установка

Для установки используется команда ```composer lib install```. В списке инсталляторов выберите **AmazonItemSearchInstaller**.

Все параметры этой библиотеки разделены на две группы:
* так называемые константные параметры, т.е. те, которые формально можно переопределить, но лучше этого не делать;
они находятся в ConfigProvider'е;
* параметры, которые выносятся в локальную настройку; те, которые можно и нужно заменить в зависимости от серверного
окружения.

При у становке инсталлер попросит установить расписание для запуска. Расписание имеет синтаксис, похожий на синтаксис
для Cron'а, но гораздо более упрощенный. Можно указать только часы и минуты в массиве через запятую или символ "*",
если Вы хотите запусткать задачу каждый час/минуту.
```
// Примеры расписания:

// Каждую минуту
'hours' => ['*'],
'minutes' => ['*']

// Каждый час в начале часа
'hours' => ['*'],
'minutes' => [0]

// Каждые полчаса  в начале и в середине часа:
'hours' => ['*'],
'minutes' => [0,30]

// Два раза в сутки: в полночь и в полдень в начале часа:
'hours' => [0,12],
'minutes' => [0]
```

В конце установки инсталлер проинформирует о том, что нужно установить параметры подключения к Amazon'у. В качестве
хранилища результатов по умолчанию используется база данных (DbTableDataStore), поэтому нужно будет прописать и
настройки подключения к базе данных.

Также иснталлер сообщит, что при поиске товаров установлены верхний и нижний предел цен. И что Вы можете либо изменить
этот коридор цен, либо отказаться от него - тогда поиск будет произведен по всему диапазону цен.

> Следует отметить, что цена должна быть установлена в "банковском виде", это когда реальная цена умножается на 100.
Т.е как бы без центов. Например, если реальная цена $11.29, то банковское ее значение будет 1129.

После этого инсталлер создаст файл локальной конфигурации **rollun.amazonItemSearch.AmazonItemSearch.dist.local.php**,
где будут размещены все эти параметры.

## Остальная конфигурация
Для работы задачи необходимо указать еще три важных параметра:
- **brandSourceDataStore**; это ресурс, откуда будуть браться брэнды и разделы (категории), в которых их (брэнды) нужно искать.
Хранилище должно быть Iterable, а строка информации, которую он возвращает, должна быть массивом,
который должен содержать два поля: **brand** и **category**. В качестве хранилища брэндов по умолчанию используется
CSV-файл (CsvDataStore). Этот тип хранилища описан в локальных настройках; Вы можете его переопределить.
- **resultDataStore**; хранилище, куда будут сливаться полученные результаты поиска. По умолчанию используется база данных.
Поэтому после установки нужно настроить подключение к ней. Но Вы можете использовать любое другой хранилище, которое
использует DataStoreInterface. Этот тип хранилища описан в локальных настройках; Вы можете его переопределить.
- **temporaryDataStore**; временное хранилище, куда складываются "сырые" данные поиска, чтобы к ним можно было потом
применить дополнительные фильтры, которых Amazon по умолчанию не дает. Этот тип хранилища описан в ConfigProvider'е
и переопределять его не рекомендуется. В качестве хранилища используется MemoryDataStore.


## Product Advertising API и библиотека ApaiIO
Для поиска товаров Amazon предоставляет специальный интерфейс Product Advertising API. В Сети полно библиотек для работы
с этим API. В нашем случае выбор был остановлен на библиотеке [ApaiIO](https://github.com/Exeu/apai-io).

Подключение к API требует простых параметров:
- **country**; страна, для/в которой производится поиск; может принимать следующие значения:
de, com, co.uk, ca, fr, co.jp, it, cn, es, in, com.br, com.mx, com.au
- **access_key**;
- **secret_key**;
- **associate_tag**; уникальный идентификатор магазина.
Для того, чтобы иметь возможность пользоваться поиском, нужно быть зарегистированным, как продавец на Amazon'е.
Последние три параметра как раз и идентифицируют продавца.

Для того, чтобы при поиске иметь более-менее полную информацию о продуктах, нужно настроить поиск специальным
набором параметров ответа - ResponseGroup. После некоторых изысканий было выяснено, что для этого вполне подходит
группа из трех следующих:
- **SalesRank**,
- **OfferFull**,
- **Large**.

Именно этот набор был включен в ConfigProvider. Опять же, Вы вольны изменить его на свой вкус. Но тогда данная задача
может дать неожиданный результат или не дать вовсе.


## AmazonItemSearchTaskCallback
В данном случае Cron запускает каждую минуту специальный callback, который инкапсулирует задачу. Данный callback проверяет
расписание запуска. И если расписание соответствует текущему времени, то основная задача запускается.


## Как это работает?
Cron запускается (обычно) каждую минуту. В числе прочих задач (если они есть) запускается также AmazonItemSearchTaskCallback.
Этот callback проверяет собственное расписание запуска, к. указано в настройках.

Когда пришло время запустить задачу, она перебирает хранилище брэндов. Дополняет параметры поиска значениями брэнда и категории для поиска.
Когда приходит ответ, из него извлекаются необходимые данные и заносятся - внимание! - во временное хранилище.

Когда поиск по брэнду завершен, и все данные находятся во временном хранилище, к нему применяются дополнительные фильтры.
В частности, производится отбор товаров, у к. SalesRank <= 300000. И уже отобранные позиции заносятся в постоянное хранилище для
результатов.

После окончания работы с одним брэндом временное хранилище очищается для экономии памяти.
